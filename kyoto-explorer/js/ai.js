/* Kyoto AI Guide System - Knowledge-based conversational AI */
(function () {
    'use strict';

    /* Rich knowledge base for each landmark */
    var KNOWLEDGE = {
        '千本鳥居': {
            history: '伏見稲荷大社は711年に創建された日本最古の稲荷神社です。千本鳥居は江戸時代から奉納が始まり、現在約1万基の鳥居が連なっています。',
            trivia: '鳥居の朱色は「生命力」を象徴し、魔除けの意味があります。一基の奉納費用は約17万円から。',
            recommend: '写真撮影は早朝がおすすめ。人が少なく、朝日が鳥居を美しく照らします。',
            season: '桜の季節（4月）と紅葉（11月）が特に美しいです。'
        },
        '五重塔': {
            history: '東寺の五重塔は高さ54.8mで、日本最高の木造塔です。826年に空海が創建し、現在の塔は1644年に徳川家光が再建したものです。',
            trivia: '五重塔は「地水火風空」の五大を表しています。心柱構造により地震に強い設計になっています。',
            recommend: '夜間ライトアップ時が最も幻想的。桜や紅葉の季節には特別公開もあります。',
            season: '春は不二桜とのコラボレーションが見事です。'
        },
        '金閣寺': {
            history: '正式名称は鹿苑寺。1397年に足利義満が建てた北山殿を寺院にしたもの。1950年に放火で焼失し、1955年に再建されました。',
            trivia: '金箔は約20kgが使用され、総工費は約7億4千万円。鏡湖池に映る「逆さ金閣」は必見です。',
            recommend: '午前中の早い時間が空いています。冬の雪化粧の金閣寺は絶景中の絶景です。',
            season: '雪の金閣（1-2月）は京都で最も人気の冬景色です。'
        },
        '竹林の道': {
            history: '嵯峨野の竹林は平安時代から貴族の別荘地でした。高さ20mを超える孟宗竹が約500mにわたって続きます。',
            trivia: '竹は1日で最大120cm成長することがあります。風がそよぐ音は「日本の音風景100選」に選ばれています。',
            recommend: '早朝5-7時が最も幻想的。竹の間から差し込む光が美しい「竹光」が見られます。',
            season: '12月の嵐山花灯路でのライトアップは必見です。'
        },
        '石庭': {
            history: '龍安寺の石庭は室町時代（1450年頃）に作られた枯山水の傑作。作者は不明で、15個の石が配置されています。',
            trivia: 'どの角度から見ても15個全ての石を同時に見ることはできません。これは「完全を求めない」禅の思想を表しています。',
            recommend: '開門直後の朝8時が最も静かに鑑賞できます。座って5分以上眺めると新しい発見があります。',
            season: '桜の季節には石庭の向こうにしだれ桜が見えます。'
        },
        '清水の舞台': {
            history: '清水寺は778年創建。現在の本堂は1633年に徳川家光が再建。舞台は釘を一本も使わない懸造工法で建てられています。',
            trivia: '「清水の舞台から飛び降りる」は江戸時代の記録では234人が飛び降り、生存率は85%でした。',
            recommend: '夕暮れ時に舞台から見る京都市街の景色は絶品。音羽の滝の水も飲んでみてください。',
            season: '紅葉（11月下旬）のライトアップは京都随一の美しさです。'
        },
        '渡月橋': {
            history: '嵐山のシンボル。平安時代に亀山天皇が「くまなき月の渡るに似る」と詠んだことが名前の由来です。全長155m。',
            trivia: '現在の橋は1934年に再建されたもの。上部は木造ですが、橋脚は鉄筋コンクリートです。',
            recommend: '春の桜と秋の紅葉時、橋の上から見る嵐山の景色は京都屈指の絶景です。',
            season: '12月の嵐山花灯路では橋全体がライトアップされます。'
        },
        '祇園花見小路': {
            history: '祇園は平安時代から続く花街。花見小路は明治時代に整備され、現在も伝統的な茶屋建築が残る京都最大の花街です。',
            trivia: '舞妓さんは15-20歳の修行中の芸妓見習い。祇園には現在約80名の舞妓がいます。',
            recommend: '夕方17時頃が、お座敷に向かう舞妓さんに出会える可能性が最も高い時間帯です。',
            season: '7月の祇園祭は日本三大祭の一つで、千年以上の歴史があります。'
        },
        '哲学の道': {
            history: '哲学者・西田幾多郎が思索にふけりながら散歩したことが名前の由来。琵琶湖疏水沿いの約2kmの散歩道です。',
            trivia: '道沿いには約500本の桜が植えられています。猫が多いことでも有名です。',
            recommend: '銀閣寺から南禅寺方面へ歩くのが定番コース。途中のカフェで休憩するのもおすすめ。',
            season: '桜（4月上旬）と紅葉（11月下旬）が最も美しい季節です。'
        },
        '二条城': {
            history: '1603年に徳川家康が京都御所の守護と上洛時の宿所として築城。1867年に大政奉還が行われた歴史的な場所です。',
            trivia: 'うぐいす張りの廊下は、侵入者を検知するための仕掛け。歩くと「キュッキュッ」と音が鳴ります。',
            recommend: '二の丸御殿の障壁画は狩野派の傑作。庭園の「鳴鶯殿」も見逃せません。',
            season: '桜の園には約400本の桜があり、夜間ライトアップも実施されます。'
        },
        '平安神宮': {
            history: '1895年に平安遷都1100年を記念して創建。社殿は平安京の朝堂院を約5/8に縮小再現したものです。',
            trivia: '大鳥居の高さは24.4mで、建立当時は日本最大でした。神苑は約1万坪の回遊式庭園です。',
            recommend: '10月の時代祭は京都三大祭の一つ。約2000人の行列が都大路を練り歩きます。',
            season: '4月の紅しだれ桜が有名。谷崎潤一郎の「細雪」にも登場します。'
        },
        '銀閣寺': {
            history: '正式名称は慈照寺。1482年に足利義政が建てた東山殿が起源。わびさびの美学を体現した建築です。',
            trivia: '金閣寺とは対照的に銀箔は貼られていません。月の光を反射させる「銀沙灘」の砂盛りが見事です。',
            recommend: '展望台からの眺めが素晴らしい。向月台と銀沙灘の幾何学美もお見逃しなく。',
            season: '紅葉時（11月）の苔と紅葉のコントラストは絶品です。'
        },
        '伏見酒蔵': {
            history: '伏見は「伏水」とも書かれ、良質な地下水に恵まれた日本有数の酒造地。月桂冠、黄桜など有名蔵元が並びます。',
            trivia: '伏見の水は「御香水」と呼ばれ、中硬水でまろやかな酒に仕上がります。酒蔵は約20軒あります。',
            recommend: '月桂冠大倉記念館では試飲が楽しめます。十石舟で酒蔵沿いを遊覧するのもおすすめ。',
            season: '3月の酒蔵開きでは限定酒の試飲ができます。'
        },
        '南禅寺水路閣': {
            history: '1888年に琵琶湖疏水の一部として建設されたレンガ造りのアーチ水路。全長93m、幅4m。',
            trivia: '設計者は田邉朔郎。当時21歳の若さでした。ローマの水道橋をモデルにしています。',
            recommend: 'アーチの間から撮る写真が人気。周辺の紅葉と赤レンガのコントラストが美しいです。',
            season: '紅葉（11月中旬〜下旬）が最も美しい。新緑の季節もおすすめです。'
        },
        '嵐山竹灯り': {
            history: '嵐山花灯路は2005年から始まった冬のイベント。竹林や渡月橋一帯が約2500基の行灯で彩られます。',
            trivia: '使用される行灯は京都の伝統工芸品。LED照明と組み合わせた幻想的な演出です。',
            recommend: '薄暮〜19時頃が最も美しい時間帯。野宮神社から竹林を通るルートがおすすめ。',
            season: '12月上旬〜中旬の期間限定イベントです。'
        }
    };

    /* General Kyoto knowledge for non-landmark queries */
    var GENERAL = [
        { kw: ['おすすめ', 'コース', 'ルート'], ans: '初めての京都なら、清水寺→祇園→哲学の道→銀閣寺の東山コースがおすすめです。半日で京都の魅力を堪能できます。' },
        { kw: ['食べ物', 'グルメ', '料理', '食事'], ans: '京都の名物は湯豆腐、おばんざい、抹茶スイーツ、にしんそば。祇園の一力茶屋や先斗町の川床料理も人気です。' },
        { kw: ['お土産', 'みやげ'], ans: '八つ橋、抹茶のお菓子、清水焼の陶器、ちりめん山椒が人気のお土産です。錦市場でのお買い物もおすすめ。' },
        { kw: ['祭り', 'イベント', '祇園祭', '葵祭'], ans: '京都三大祭は葵祭（5月）、祇園祭（7月）、時代祭（10月）。特に祇園祭は1100年以上の歴史を持つ日本最大級の祭です。' },
        { kw: ['桜', '花見', '春'], ans: '桜の名所は哲学の道、円山公園、醍醐寺、仁和寺。見頃は例年3月下旬〜4月上旬です。' },
        { kw: ['紅葉', '秋', 'もみじ'], ans: '紅葉の名所は東福寺、永観堂、嵐山、清水寺。見頃は11月中旬〜下旬。ライトアップも見逃せません。' },
        { kw: ['歴史', '文化'], ans: '京都は794年から1868年まで日本の首都でした。17の世界遺産と2000以上の寺社があります。' },
        { kw: ['天気', '気候', '服装'], ans: '京都は盆地のため夏は蒸し暑く冬は底冷えします。夏は薄着+日傘、冬は防寒対策が必須です。' },
        { kw: ['交通', 'バス', '電車'], ans: '市バスの一日乗車券（700円）が便利。地下鉄と組み合わせれば主要観光地を効率よく回れます。' },
        { kw: ['舞妓', '芸妓', '花街'], ans: '舞妓さんに出会えるのは祇園・先斗町・宮川町。夕方の花見小路が最も遭遇率が高いです。写真撮影のマナーにご注意を。' }
    ];

    /* Context-aware tips based on game state */
    var CONTEXT_TIPS = {
        dawn: ['朝の京都は清々しい空気に包まれています。早朝の寺社はとても静かで心が洗われます。', '朝霧の中の金閣寺は、まるで水墨画のような美しさです。'],
        day: ['日中の京都は活気にあふれています。散策日和ですね！', '真昼の竹林は、木漏れ日が作る光と影のコントラストが美しいです。'],
        dusk: ['黄昏の京都は最も情緒があります。灯篭に灯りが灯り始める時間です。', '夕暮れの渡月橋から見る嵐山のシルエットは京都随一の風景です。'],
        night: ['夜の京都は幻想的な雰囲気に包まれます。ライトアップされた寺社は昼とは別世界です。', '夜の祇園花見小路は、提灯の灯りが映える最も美しい時間帯です。'],
        rain: ['雨の京都も風情があります。濡れた石畳に反射する灯りが美しいですよ。', '雨の日の苔寺や石庭は、緑が一層鮮やかになります。'],
        snow: ['雪化粧の京都は年に数回しか見られない貴重な光景です。', '雪の金閣寺は京都で最も美しい冬の風景と言われています。']
    };

    window.KyotoAI = {
        chatHistory: [],
        tipTimer: 0,
        lastTipIdx: -1,

        respond: function (input) {
            input = input.trim();
            if (!input) return null;

            /* Check for landmark-specific queries */
            for (var name in KNOWLEDGE) {
                if (input.indexOf(name) !== -1) {
                    var k = KNOWLEDGE[name];
                    if (input.indexOf('歴史') !== -1 || input.indexOf('いつ') !== -1 || input.indexOf('由来') !== -1)
                        return '📜 ' + k.history;
                    if (input.indexOf('豆知識') !== -1 || input.indexOf('トリビア') !== -1 || input.indexOf('面白い') !== -1)
                        return '💡 ' + k.trivia;
                    if (input.indexOf('おすすめ') !== -1 || input.indexOf('いつ行く') !== -1 || input.indexOf('写真') !== -1)
                        return '📷 ' + k.recommend;
                    if (input.indexOf('季節') !== -1 || input.indexOf('時期') !== -1)
                        return '🌸 ' + k.season;
                    /* Default: return combined info */
                    return '⛩️ ' + k.history + '\n\n💡 ' + k.trivia;
                }
            }

            /* Check general knowledge */
            for (var i = 0; i < GENERAL.length; i++) {
                var g = GENERAL[i];
                for (var j = 0; j < g.kw.length; j++) {
                    if (input.indexOf(g.kw[j]) !== -1) return '🗾 ' + g.ans;
                }
            }

            /* Navigation queries */
            if (input.indexOf('どこ') !== -1 || input.indexOf('場所') !== -1 || input.indexOf('近く') !== -1)
                return '🗺️ 画面右上のミニマップで現在地を確認できます。地図ボタンで全体マップが開きます。未踏のスポットにはNEWマークが表示されますよ！';

            if (input.indexOf('操作') !== -1 || input.indexOf('動き') !== -1 || input.indexOf('使い方') !== -1)
                return '🎮 WASD/矢印キーで移動、マウスで視点操作。Shiftでダッシュ。📱モバイルはジョイスティック+右側タッチで視点操作です。';

            if (input.indexOf('御朱印') !== -1 || input.indexOf('スタンプ') !== -1 || input.indexOf('集め') !== -1)
                return '📜 各ランドマークに近づくと自動で御朱印がもらえます。15箇所全ての御朱印を集めてコンプリートを目指しましょう！';

            if (input.indexOf('こんにちは') !== -1 || input.indexOf('こんばんは') !== -1 || input.indexOf('はじめ') !== -1 || input.indexOf('やあ') !== -1)
                return '👘 ようこそ京都へ！私はAIガイドの「みやこ」です。京都の歴史や名所について何でもお聞きください。例えば「金閣寺の歴史」「おすすめコース」「祇園祭について」など！';

            /* Default response */
            var defaults = [
                '🤔 すみません、よく分かりませんでした。ランドマーク名（例：「金閣寺」）や「おすすめコース」「グルメ」などのキーワードでお尋ねください。',
                '👘 何でもお聞きください！「清水寺の歴史」「桜の名所」「お土産」など、京都のことなら何でもお答えします。',
                '💡 ヒント：各スポット名+「歴史」「豆知識」「おすすめ」「季節」で詳しい情報が得られます！'
            ];
            return defaults[Math.floor(Math.random() * defaults.length)];
        },

        getContextTip: function (timeKey, weather) {
            var pool = CONTEXT_TIPS[timeKey] || [];
            if (weather !== 'clear' && CONTEXT_TIPS[weather]) pool = pool.concat(CONTEXT_TIPS[weather]);
            if (pool.length === 0) return null;
            var idx = Math.floor(Math.random() * pool.length);
            if (idx === this.lastTipIdx && pool.length > 1) idx = (idx + 1) % pool.length;
            this.lastTipIdx = idx;
            return pool[idx];
        },

        getRouteAdvice: function (camPos, spots, gosyuin) {
            var nearest = null, nd = Infinity;
            for (var i = 0; i < spots.length; i++) {
                if (gosyuin.has(i)) continue;
                var dx = camPos.x - spots[i].pos[0], dz = camPos.z - spots[i].pos[2];
                var d = Math.sqrt(dx * dx + dz * dz);
                if (d < nd) { nd = d; nearest = { idx: i, spot: spots[i], dist: d }; }
            }
            return nearest;
        }
    };
})();
